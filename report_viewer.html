<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á—ë—Ç–æ–≤ –ø–æ —Ç–µ–Ω–¥–µ—Ä–∞–º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .file-selector {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .file-selector label {
            font-weight: 600;
            color: #555;
            font-size: 1.1em;
        }

        .file-selector select {
            flex: 1;
            min-width: 300px;
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-selector select:hover {
            border-color: #667eea;
        }

        .file-selector select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .file-selector label[for="fileInput"]:hover {
            background: #764ba2 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        #generateReportBtn:hover:not(:disabled) {
            background: #764ba2 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        #generateReportBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #advertIdInput:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .content {
            padding: 40px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #999;
            font-size: 1.2em;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #c33;
            margin: 20px 0;
        }

        .section {
            margin-bottom: 40px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            border-left: 5px solid #667eea;
        }

        .section-title {
            font-size: 1.8em;
            color: #667eea;
            margin-bottom: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: "‚ñ∏";
            font-size: 0.8em;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .info-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .info-label {
            font-weight: 600;
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .info-value {
            font-size: 1.1em;
            color: #333;
            word-wrap: break-word;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-top: 5px;
        }

        .status-published {
            background: #d4edda;
            color: #155724;
        }

        .status-other {
            background: #fff3cd;
            color: #856404;
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .text-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            line-height: 1.8;
            color: #444;
            white-space: pre-wrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .text-content h3 {
            color: #667eea;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .text-content h3:first-child {
            margin-top: 0;
        }

        .text-content ul, .text-content ol {
            margin-left: 20px;
            margin-top: 10px;
        }

        .text-content li {
            margin-bottom: 8px;
        }

        .file-list {
            list-style: none;
            padding: 0;
        }

        .file-list li {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .file-list a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s;
        }

        .file-list a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .file-icon {
            font-size: 1.5em;
        }

        .amount {
            font-size: 1.3em;
            font-weight: 700;
            color: #667eea;
        }

        .highlight-box {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .highlight-box .info-label {
            color: #667eea;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .content {
                padding: 20px;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .file-selector {
                flex-direction: column;
            }

            .file-selector select {
                width: 100%;
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä –û—Ç—á—ë—Ç—ã –ø–æ —Ç–µ–Ω–¥–µ—Ä–∞–º</h1>
            <p>–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–∫—É–ø–∫–∞—Ö</p>
        </div>

        <div class="controls">
            <!-- –§–æ—Ä–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –æ—Ç—á—ë—Ç–∞ -->
            <div style="margin-bottom: 25px; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                <div style="font-weight: 600; color: #667eea; margin-bottom: 15px; font-size: 1.1em;">üìù –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –æ—Ç—á—ë—Ç</div>
                <div class="file-selector" style="margin-bottom: 0;">
                    <input type="number" id="advertIdInput" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –æ–±—ä—è–≤–ª–µ–Ω–∏—è" 
                           style="flex: 1; min-width: 200px; padding: 12px 20px; border: 2px solid #ddd; border-radius: 10px; font-size: 1em;">
                    <button id="generateReportBtn" 
                            style="padding: 12px 30px; background: #667eea; color: white; border: none; border-radius: 10px; font-weight: 600; font-size: 1em; cursor: pointer; transition: all 0.3s; margin-left: 10px;">
                        –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç
                    </button>
                </div>
                <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä -->
                <div id="progressContainer" style="display: none; margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9em; color: #666;">
                        <span id="progressMessage">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div style="width: 100%; height: 25px; background: #e0e0e0; border-radius: 12px; overflow: hidden;">
                        <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.85em;"></div>
                    </div>
                    <div id="progressError" style="display: none; margin-top: 10px; padding: 10px; background: #fee; color: #c33; border-radius: 5px; border-left: 4px solid #c33;"></div>
                </div>
            </div>
            
            <!-- –í—ã–±–æ—Ä —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –æ—Ç—á—ë—Ç–∞ -->
            <div class="file-selector">
                <label for="fileInput" style="cursor: pointer; padding: 12px 20px; background: #667eea; color: white; border-radius: 10px; font-weight: 600; transition: all 0.3s;">
                    üìÅ –í—ã–±—Ä–∞—Ç—å JSON —Ñ–∞–π–ª
                </label>
                <input type="file" id="fileInput" accept=".json" style="display: none;">
                <span style="color: #666; margin-left: 15px;" id="fileName">–∏–ª–∏</span>
                <label for="reportSelect" style="margin-left: 15px;">–∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –ø–∞–ø–∫–∏ reports:</label>
                <select id="reportSelect" style="flex: 1; min-width: 200px;">
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç—á—ë—Ç --</option>
                </select>
            </div>
        </div>

        <div class="content" id="content">
            <div class="loading">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç—á—ë—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ</div>
        </div>
    </div>

    <script>
        let reportsList = [];

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö JSON —Ñ–∞–π–ª–æ–≤
        async function loadReportsList() {
            try {
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ API
                try {
                    const response = await fetch('/api/reports');
                    if (response.ok) {
                        const data = await response.json();
                        reportsList = data.reports || [];
                        updateSelect();
                        return;
                    }
                } catch (e) {
                    // API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–±—É–µ–º —Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–±
                }
                
                // Fallback: —Å–ø–∏—Å–æ–∫ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏–∑ –ø–∞–ø–∫–∏ reports
                const knownFiles = ['goszakup_15768351.json', 'goszakup_15755249.json'];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∏–µ —Ñ–∞–π–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω)
                const availableFiles = [];
                for (const file of knownFiles) {
                    try {
                        const response = await fetch(`reports/${file}`, { method: 'HEAD' });
                        if (response.ok) {
                            availableFiles.push(file);
                        }
                    } catch (e) {
                        // –§–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ fetch (–Ω–µ—Ç –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞) - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
                        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª —á–µ—Ä–µ–∑ input
                    }
                }

                reportsList = availableFiles;
                updateSelect();
                
                // –ï—Å–ª–∏ —Ñ–∞–π–ª—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ fetch, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
                if (availableFiles.length === 0) {
                    const select = document.getElementById('reportSelect');
                    select.innerHTML = '<option value="">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–í—ã–±—Ä–∞—Ç—å JSON —Ñ–∞–π–ª" –≤—ã—à–µ</option>';
                }
            } catch (error) {
                console.error('Error loading reports list:', error);
                const select = document.getElementById('reportSelect');
                select.innerHTML = '<option value="">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–í—ã–±—Ä–∞—Ç—å JSON —Ñ–∞–π–ª" –≤—ã—à–µ</option>';
            }
        }

        function updateSelect() {
            const select = document.getElementById('reportSelect');
            select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç—á—ë—Ç --</option>';
            
            reportsList.forEach(file => {
                const option = document.createElement('option');
                option.value = file;
                option.textContent = file.replace('.json', '').replace('_', ' ').toUpperCase();
                select.appendChild(option);
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç—á—ë—Ç–∞
        async function loadReport(filename) {
            const content = document.getElementById('content');
            content.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–∞...</div>';

            try {
                const response = await fetch(`reports/${filename}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                displayReport(data);
            } catch (error) {
                content.innerHTML = `
                    <div class="error">
                        <strong>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á—ë—Ç–∞:</strong><br>
                        ${error.message}<br><br>
                        <small>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª ${filename} —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ø–∞–ø–∫–µ reports/</small>
                    </div>
                `;
            }
        }

        function displayReport(data) {
            const content = document.getElementById('content');
            let html = '';

            // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–Ω–¥–µ—Ä–µ
            html += `
                <div class="section">
                    <div class="section-title">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
                    <div class="info-grid">
                        ${data.tender_id ? `<div class="info-item">
                            <div class="info-label">ID —Ç–µ–Ω–¥–µ—Ä–∞</div>
                            <div class="info-value">${escapeHtml(data.tender_id)}</div>
                        </div>` : ''}
                        ${data.tender_status ? `<div class="info-item">
                            <div class="info-label">–°—Ç–∞—Ç—É—Å</div>
                            <div class="info-value">
                                ${escapeHtml(data.tender_status)}
                                <span class="status-badge ${data.tender_status.toLowerCase().includes('–æ–ø—É–±–ª–∏–∫') ? 'status-published' : 'status-other'}">
                                    ${escapeHtml(data.tender_status)}
                                </span>
                            </div>
                        </div>` : ''}
                        ${data.publication_date ? `<div class="info-item">
                            <div class="info-label">–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</div>
                            <div class="info-value">${escapeHtml(data.publication_date)}</div>
                        </div>` : ''}
                        ${data.procurement_method ? `<div class="info-item">
                            <div class="info-label">–ú–µ—Ç–æ–¥ –∑–∞–∫—É–ø–∫–∏</div>
                            <div class="info-value">${escapeHtml(data.procurement_method)}</div>
                        </div>` : ''}
                        ${data.procurement_type ? `<div class="info-item">
                            <div class="info-label">–¢–∏–ø –∑–∞–∫—É–ø–∫–∏</div>
                            <div class="info-value">${escapeHtml(data.procurement_type)}</div>
                        </div>` : ''}
                        ${data.subject_type ? `<div class="info-item">
                            <div class="info-label">–¢–∏–ø –ø—Ä–µ–¥–º–µ—Ç–∞</div>
                            <div class="info-value">${escapeHtml(data.subject_type)}</div>
                        </div>` : ''}
                        ${data.applications_count !== undefined ? `<div class="info-item">
                            <div class="info-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—è–≤–æ–∫</div>
                            <div class="info-value">${data.applications_count}</div>
                        </div>` : ''}
                        ${data.procurement_amount ? `<div class="info-item highlight-box">
                            <div class="info-label">–°—É–º–º–∞ –∑–∞–∫—É–ø–∫–∏</div>
                            <div class="info-value amount">${escapeHtml(data.procurement_amount)} ‚Ç∏</div>
                        </div>` : ''}
                    </div>
                </div>
            `;

            // –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–Ω–¥–µ—Ä–∞
            if (data.tender_name) {
                html += `
                    <div class="section">
                        <div class="section-title">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–Ω–¥–µ—Ä–∞</div>
                        <div class="text-content">
                            <strong>${escapeHtml(data.tender_name)}</strong>
                        </div>
                    </div>
                `;
            }

            // –°—Ä–æ–∫–∏
            if (data.—Å—Ä–æ–∫_–Ω–∞—á–∞–ª–∞_–æ–±—Å—É–∂–¥–µ–Ω–∏—è || data.—Å—Ä–æ–∫_–æ–∫–æ–Ω—á–∞–Ω–∏—è_–æ–±—Å—É–∂–¥–µ–Ω–∏—è || 
                data.–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π_—Å—Ä–æ–∫_–Ω–∞—á–∞–ª–∞_–ø—Ä–∏–µ–º–∞_–∑–∞—è–≤–æ–∫ || data.–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π_—Å—Ä–æ–∫_–æ–∫–æ–Ω—á–∞–Ω–∏—è_–ø—Ä–∏–µ–º–∞_–∑–∞—è–≤–æ–∫) {
                html += `
                    <div class="section">
                        <div class="section-title">–°—Ä–æ–∫–∏</div>
                        <div class="info-grid">
                            ${data.—Å—Ä–æ–∫_–Ω–∞—á–∞–ª–∞_–æ–±—Å—É–∂–¥–µ–Ω–∏—è ? `<div class="info-item">
                                <div class="info-label">–ù–∞—á–∞–ª–æ –æ–±—Å—É–∂–¥–µ–Ω–∏—è</div>
                                <div class="info-value">${escapeHtml(data.—Å—Ä–æ–∫_–Ω–∞—á–∞–ª–∞_–æ–±—Å—É–∂–¥–µ–Ω–∏—è)}</div>
                            </div>` : ''}
                            ${data.—Å—Ä–æ–∫_–æ–∫–æ–Ω—á–∞–Ω–∏—è_–æ–±—Å—É–∂–¥–µ–Ω–∏—è ? `<div class="info-item">
                                <div class="info-label">–û–∫–æ–Ω—á–∞–Ω–∏–µ –æ–±—Å—É–∂–¥–µ–Ω–∏—è</div>
                                <div class="info-value">${escapeHtml(data.—Å—Ä–æ–∫_–æ–∫–æ–Ω—á–∞–Ω–∏—è_–æ–±—Å—É–∂–¥–µ–Ω–∏—è)}</div>
                            </div>` : ''}
                            ${data.–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π_—Å—Ä–æ–∫_–Ω–∞—á–∞–ª–∞_–ø—Ä–∏–µ–º–∞_–∑–∞—è–≤–æ–∫ ? `<div class="info-item">
                                <div class="info-label">–ù–∞—á–∞–ª–æ –ø—Ä–∏—ë–º–∞ –∑–∞—è–≤–æ–∫</div>
                                <div class="info-value">${escapeHtml(data.–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π_—Å—Ä–æ–∫_–Ω–∞—á–∞–ª–∞_–ø—Ä–∏–µ–º–∞_–∑–∞—è–≤–æ–∫)}</div>
                            </div>` : ''}
                            ${data.–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π_—Å—Ä–æ–∫_–æ–∫–æ–Ω—á–∞–Ω–∏—è_–ø—Ä–∏–µ–º–∞_–∑–∞—è–≤–æ–∫ ? `<div class="info-item">
                                <div class="info-label">–û–∫–æ–Ω—á–∞–Ω–∏–µ –ø—Ä–∏—ë–º–∞ –∑–∞—è–≤–æ–∫</div>
                                <div class="info-value">${escapeHtml(data.–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π_—Å—Ä–æ–∫_–æ–∫–æ–Ω—á–∞–Ω–∏—è_–ø—Ä–∏–µ–º–∞_–∑–∞—è–≤–æ–∫)}</div>
                            </div>` : ''}
                        </div>
                    </div>
                `;
            }

            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–µ
            if (data.organizer_name || data.organizer_legal_address || data.organizer_bin || 
                data.representative_name || data.position || data.email) {
                html += `
                    <div class="section">
                        <div class="section-title">–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä</div>
                        <div class="info-grid">
                            ${data.organizer_name ? `<div class="info-item">
                                <div class="info-label">–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</div>
                                <div class="info-value">${escapeHtml(data.organizer_name)}</div>
                            </div>` : ''}
                            ${data.organizer_bin ? `<div class="info-item">
                                <div class="info-label">–ë–ò–ù</div>
                                <div class="info-value">${escapeHtml(data.organizer_bin)}</div>
                            </div>` : ''}
                            ${data.organizer_legal_address ? `<div class="info-item">
                                <div class="info-label">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å</div>
                                <div class="info-value">${escapeHtml(data.organizer_legal_address)}</div>
                            </div>` : ''}
                            ${data.representative_name ? `<div class="info-item">
                                <div class="info-label">–ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å</div>
                                <div class="info-value">${escapeHtml(data.representative_name)}</div>
                            </div>` : ''}
                            ${data.position ? `<div class="info-item">
                                <div class="info-label">–î–æ–ª–∂–Ω–æ—Å—Ç—å</div>
                                <div class="info-value">${escapeHtml(data.position)}</div>
                            </div>` : ''}
                            ${data.email ? `<div class="info-item">
                                <div class="info-label">Email</div>
                                <div class="info-value"><a href="mailto:${escapeHtml(data.email)}">${escapeHtml(data.email)}</a></div>
                            </div>` : ''}
                        </div>
                    </div>
                `;
            }

            // –õ–æ—Ç—ã
            if (data.lots_info && data.lots_info.length > 0) {
                html += `
                    <div class="section">
                        <div class="section-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª–æ—Ç–∞—Ö (${data.lots_info.length})</div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>‚Ññ</th>
                                        <th>ID –ª–æ—Ç–∞</th>
                                        <th>–ù–æ–º–µ—Ä –ª–æ—Ç–∞</th>
                                        <th>–ó–∞–∫–∞–∑—á–∏–∫</th>
                                        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                                        <th>–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É</th>
                                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                        <th>–ü–ª–∞–Ω–æ–≤–∞—è —Å—É–º–º–∞</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                data.lots_info.forEach(lot => {
                    html += `
                        <tr>
                            <td>${escapeHtml(lot.seq_num || '')}</td>
                            <td>${escapeHtml(lot.lot_id || '')}</td>
                            <td>${escapeHtml(lot.lot_number || '')}</td>
                            <td>${escapeHtml(lot.customer || '')}</td>
                            <td>${escapeHtml(lot.item_name || '')}</td>
                            <td>${escapeHtml(lot.unit_price || '')} ${escapeHtml(lot.unit_of_measure || '')}</td>
                            <td>${escapeHtml(lot.quantity || '')}</td>
                            <td><strong>${escapeHtml(lot.planned_amount || '')} ‚Ç∏</strong></td>
                            <td>${escapeHtml(lot.lot_status || '')}</td>
                        </tr>
                    `;
                });
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            // –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ (—Ñ–∞–π–ª—ã)
            if (data.techspec_files && data.techspec_files.length > 0) {
                html += `
                    <div class="section">
                        <div class="section-title">–§–∞–π–ª—ã —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–π</div>
                        <ul class="file-list">
                `;
                data.techspec_files.forEach(file => {
                    html += `
                        <li>
                            <span class="file-icon">üìÑ</span>
                            <div style="flex: 1;">
                                <strong>${escapeHtml(file.file_name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</strong><br>
                                <small>–õ–æ—Ç ID: ${escapeHtml(file.lot_id || 'N/A')}</small>
                            </div>
                            ${file.file_link ? `<a href="${escapeHtml(file.file_link)}" target="_blank">–°–∫–∞—á–∞—Ç—å</a>` : ''}
                        </li>
                    `;
                });
                html += `
                        </ul>
                    </div>
                `;
            }

            // –ê—Ç—Ä–∏–±—É—Ç—ã
            if (data.attributes && data.attributes.length > 0) {
                html += `
                    <div class="section">
                        <div class="section-title">–ê—Ç—Ä–∏–±—É—Ç—ã</div>
                        <div class="info-grid">
                `;
                data.attributes.forEach(attr => {
                    html += `
                        <div class="info-item">
                            <div class="info-value">${escapeHtml(attr)}</div>
                        </div>
                    `;
                });
                html += `
                        </div>
                    </div>
                `;
            }

            // –ê–Ω–∞–ª–∏–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏
            if (data.techspec_analyzed) {
                html += `
                    <div class="section">
                        <div class="section-title">–ê–Ω–∞–ª–∏–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏</div>
                        <div class="text-content">${formatTextContent(data.techspec_analyzed)}</div>
                    </div>
                `;
            }

            // –ê–Ω–∞–ª–∏–∑ –∞—Ñ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏
            if (data.affiliate_analysis) {
                html += `
                    <div class="section">
                        <div class="section-title">–ê–Ω–∞–ª–∏–∑ –∞—Ñ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏</div>
                        <div class="text-content">${formatTextContent(data.affiliate_analysis)}</div>
                    </div>
                `;
            }

            content.innerHTML = html || '<div class="empty-state">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
        }

        function formatTextContent(text) {
            if (!text) return '';
            
            // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –Ω–∞ <br>
            let formatted = escapeHtml(text);
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–Ω–æ–º–µ—Ä–∞ —Ä–∞–∑–¥–µ–ª–æ–≤)
            formatted = formatted.replace(/(\d+\))\s+([–ê-–Ø–Å][^\n]+)/g, '<h3>$1 $2</h3>');
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–ø–∏—Å–∫–∏
            formatted = formatted.replace(/^-\s+([^\n]+)$/gm, '<li>$1</li>');
            formatted = formatted.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
            
            // –í—ã–¥–µ–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏
            formatted = formatted.replace(/–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∞—Ñ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏:\s*(\d+%)/gi, 
                '<div class="highlight-box"><strong>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∞—Ñ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏: <span style="font-size: 1.5em; color: #667eea;">$1</span></strong></div>');
            
            return formatted;
        }

        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ FileReader
        function loadFileFromInput(file) {
            const content = document.getElementById('content');
            content.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–∞...</div>';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    displayReport(data);
                    document.getElementById('fileName').textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω: ${file.name}`;
                } catch (error) {
                    content.innerHTML = `
                        <div class="error">
                            <strong>–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:</strong><br>
                            ${error.message}
                        </div>
                    `;
                }
            };
            reader.onerror = function() {
                content.innerHTML = `
                    <div class="error">
                        <strong>–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞</strong>
                    </div>
                `;
            };
            reader.readAsText(file);
        }

        let statusCheckInterval = null;
        let currentTaskId = null;

        // –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞
        async function startParsing(advertId) {
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressMessage = document.getElementById('progressMessage');
            const progressPercent = document.getElementById('progressPercent');
            const progressError = document.getElementById('progressError');
            const generateBtn = document.getElementById('generateReportBtn');
            
            // –°–±—Ä–æ—Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            progressError.style.display = 'none';
            progressContainer.style.display = 'block';
            generateBtn.disabled = true;
            generateBtn.textContent = '–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ...';
            progressBar.style.width = '0%';
            progressPercent.textContent = '0%';
            progressMessage.textContent = '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...';
            
            try {
                const response = await fetch('/api/parse', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ advert_id: advertId })
                });
                
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–∞—Ä—Å–∏–Ω–≥–∞');
                }
                
                const data = await response.json();
                currentTaskId = data.task_id;
                
                // –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞
                checkStatus(currentTaskId);
                
            } catch (error) {
                progressError.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
                progressError.style.display = 'block';
                generateBtn.disabled = false;
                generateBtn.textContent = '–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç';
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏
        async function checkStatus(taskId) {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            
            statusCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/status/${taskId}`);
                    if (!response.ok) {
                        throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
                    }
                    
                    const status = await response.json();
                    updateProgress(status);
                    
                    if (status.status === 'completed') {
                        clearInterval(statusCheckInterval);
                        statusCheckInterval = null;
                        document.getElementById('generateReportBtn').disabled = false;
                        document.getElementById('generateReportBtn').textContent = '–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç';
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                        if (status.result) {
                            setTimeout(() => {
                                loadReport(status.result);
                                loadReportsList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ—Ç—á—ë—Ç–æ–≤
                            }, 500);
                        }
                    } else if (status.status === 'error') {
                        clearInterval(statusCheckInterval);
                        statusCheckInterval = null;
                        document.getElementById('generateReportBtn').disabled = false;
                        document.getElementById('generateReportBtn').textContent = '–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç';
                        
                        const progressError = document.getElementById('progressError');
                        progressError.textContent = `–û—à–∏–±–∫–∞: ${status.error || status.message}`;
                        progressError.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error checking status:', error);
                }
            }, 1000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
        function updateProgress(status) {
            const progressBar = document.getElementById('progressBar');
            const progressMessage = document.getElementById('progressMessage');
            const progressPercent = document.getElementById('progressPercent');
            
            const progress = status.progress || 0;
            progressBar.style.width = `${progress}%`;
            progressPercent.textContent = `${progress}%`;
            progressMessage.textContent = status.message || '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            loadReportsList();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç"
            document.getElementById('generateReportBtn').addEventListener('click', () => {
                const advertId = document.getElementById('advertIdInput').value;
                if (!advertId || isNaN(advertId)) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –æ–±—ä—è–≤–ª–µ–Ω–∏—è');
                    return;
                }
                startParsing(parseInt(advertId));
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('advertIdInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('generateReportBtn').click();
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ input
            document.getElementById('fileInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.name.endsWith('.json')) {
                        loadFileFromInput(file);
                    } else {
                        document.getElementById('content').innerHTML = `
                            <div class="error">
                                <strong>–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞:</strong><br>
                                –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ JSON —Ñ–∞–π–ª (.json)
                            </div>
                        `;
                    }
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
            document.getElementById('reportSelect').addEventListener('change', (e) => {
                if (e.target.value) {
                    loadReport(e.target.value);
                    document.getElementById('fileName').textContent = '–∏–ª–∏';
                } else {
                    document.getElementById('content').innerHTML = 
                        '<div class="loading">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç—á—ë—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª</div>';
                }
            });
        });
    </script>
</body>
</html>
